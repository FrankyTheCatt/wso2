# Configuración de Nginx para Docker
# Esta configuración está optimizada para ejecutarse dentro de un contenedor

upstream mini_app {
    # Apuntar a la mini-app corriendo en el host (fuera de Docker)
    # host.docker.internal funciona en Windows y Mac
    # En Linux, usa la IP del host o configura network_mode: host
    server host.docker.internal:3000;
}

server {
    listen 80;
    server_name _;  # Acepta cualquier hostname

    # Logs a stdout/stderr para que Docker los capture
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Tamaño máximo de body
    client_max_body_size 10M;

    # Pasar headers importantes al backend
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # ============================================
    # ENDPOINT INTERNO: auth-check
    # ============================================
    location = /auth-check {
        internal;
        proxy_pass http://mini_app/auth-check;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Cookie $http_cookie;
    }

    # ============================================
    # RECURSOS PÚBLICOS (sin autenticación)
    # ============================================
    # Login, callback, logout, health, archivos estáticos
    location ~ ^/(login|callback|logout|logout/callback|health|index\.html|\.(css|js|png|jpg|gif|ico|svg))$ {
        proxy_pass http://mini_app;
        proxy_set_header Cookie $http_cookie;
    }

    # ============================================
    # RECURSOS PROTEGIDOS (requieren autenticación)
    # ============================================
    # Ejemplo: Proteger una ruta específica
    location /recurso-protegido/ {
        auth_request /auth-check;
        error_page 401 = @login;
        proxy_pass http://mini_app;
        proxy_set_header Cookie $http_cookie;
    }

    # Proteger rutas de API
    location ~ ^/(api|admin|me|protected\.html)/ {
        auth_request /auth-check;
        error_page 401 = @login;
        proxy_pass http://mini_app;
        proxy_set_header Cookie $http_cookie;
    }

    # ============================================
    # HANDLER DE LOGIN (cuando hay 401)
    # ============================================
    location @login {
        return 302 http://$host/login;
    }

    # ============================================
    # RUTA POR DEFECTO (pasar todo al backend)
    # ============================================
    location / {
        proxy_pass http://mini_app;
        proxy_set_header Cookie $http_cookie;
    }
}

